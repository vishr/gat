#!/usr/bin/env node

var program = require("commander");
var path = require("path");
var fs = require("fs-extra");
var spawn = require("child_process").spawn;
var net = require("net");
var winston = require("winston");
var pkg = require("../package.json");
var cfg = require("../cacher").cfg;

// Logging
var logger = new winston.Logger({
  transports: [
  new winston.transports.Console({
    colorize: true,
    prettyPrint: true
  })]
});

program.version(pkg.version);

program.command("config").description("Show config").action(function() {
  try {
    var data = fs.readJsonSync(path.join(__dirname, "..", "config.json"));
    logger.info(data);
  } catch (e) {
    logger.error("Error reading config");
    // process.exit(1);
  }
});

program.command("start").description("Start cacher").action(function() {
  logger.info("Starting cacher on port " + cfg.port.grey);

  var client = net.connect({
    port: cfg.port
  });

  // Check if already running
  client.on("connect", function() {
    logger.error("Error starting cacher - " + "port already in use".yellow);
    // process.exit(-1);
  });

  client.on("error", function() {
    // Start cacher
    var child = spawn(process.execPath, ["server"], {
      detached: true,
      stdio: ["ignore", "ignore", "ignore"]
    });

    try {
      fs.writeFileSync(cfg.pidFile, child.pid);
      child.unref();
    } catch(e) {
      logger.error("Error starting cacher");
      // process.exit(1);
    }
  });
});

program.command("stop").description("Stop cacher").action(function() {
  logger.warn("Stopping cacher");
  try {
    var pid = fs.readFileSync(cfg.pidFile, "utf-8");
    process.kill(pid);
  } catch(e) {
    logger.error("Error stopping cacher - " + "not running".yellow);
    // process.exit(1);
  }
});

program.command("empty").description("Empty cache").action(function() {
  logger.warn("Emptying cache");
  try {
    fs.removeSync(cfg.root);
  } catch(e) {
    logger.error("Error emptying cache");
    // process.exit(1);
  }
});

program.parse(process.argv);